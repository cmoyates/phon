<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<opgraph xmlns="http://gedge.ca/ns/opgraph" xmlns:nes="https://www.phon.ca/ns/node_editor" xmlns:oga="http://gedge.ca/ns/opgraph-app" xmlns:opqry="https://phon.ca/ns/opgraph_query" xmlns:qry="http://phon.ling.mun.ca/ns/query">
    <graph id="root">
        <node id="36b3d879" name="Project" type="class:ca.gedge.opgraph.nodes.reflect.ObjectNode">
            <extensions>
                <oga:settings>
                    <oga:property key="ca.gedge.opgraph.nodes.reflect.ObjectNode.declaredClass"><![CDATA[ca.phon.project.Project]]></oga:property>
                    <oga:property key="contextKey"><![CDATA[_project]]></oga:property>
                </oga:settings>
                <oga:meta x="15" y="15"/>
            </extensions>
        </node>
        <node id="3d5a75bf" name="ArrayList" type="class:ca.gedge.opgraph.nodes.reflect.ObjectNode">
            <extensions>
                <oga:settings>
                    <oga:property key="ca.gedge.opgraph.nodes.reflect.ObjectNode.declaredClass"><![CDATA[java.util.ArrayList]]></oga:property>
                    <oga:property key="contextKey"><![CDATA[_selectedSessions]]></oga:property>
                </oga:settings>
                <oga:meta x="93" y="245"/>
            </extensions>
        </node>
        <opqry:queryNode id="6eccf1d5" name="Query : PCC-PVC" type="ca.phon.app.opgraph.nodes.query.QueryNode">
            <qry:query xmlns="http://phon.ling.mun.ca/ns/query" date="2016-05-05T11:53:17.641-02:30" name="PCC-PVC" uuid="2aed62e5-3ec9-4379-9fe3-e28b08347c93">
                <script>
                    <source>/*
params = {separator, "Information", false},
			{label, "&lt;html&gt;&lt;p&gt;This script calculates PCC/PVC (percent consonants/vowels correct)&lt;br/&gt; for each group in the selected sessions.&lt;/p&gt;&lt;/html&gt;", ""},
			{label, "&lt;html&gt;&lt;br/&gt;&lt;p&gt;Results are reported as:&lt;br/&gt;&amp;lt;# correct&amp;gt;/&amp;lt;# attempted&amp;gt;;&amp;lt;# deleted&amp;gt;;&amp;lt;# epenthesized&amp;gt;&lt;/p&gt;&lt;/html&gt;", ""}
        ;
*/

var GroupFilter = require("lib/GroupFilter").GroupFilter;
var AlignedGroupFilter = require("lib/TierFilter").TierFilter;
var ParticipantFilter = require("lib/ParticipantFilter").ParticipantFilter;
var WordFilter = require("lib/WordFilter").WordFilter;
var AlignedWordFilter = require("lib/TierFilter").TierFilter;
var PccOptions = require("lib/Pcc").PccOptions;
var Pcc = require("lib/Pcc").Pcc;

var ignoreTruncatedParamInfo = {
	"id": "ignoreTruncated",
	"desc": "Ignore truncated words",
	"title": "",
	"def": true
};
var ignoreTruncatedParam;
var ignoreTruncated = ignoreTruncatedParamInfo.def;

var pccOptions = {
    "standard": new PccOptions("pccOptions.standard"),
    "aligned": new PccOptions("pccOptions.aligned")
};

var filters = {
	"group": new GroupFilter("filters.group"),
	"alignedGroup": new AlignedGroupFilter("filters.alignedGroup"),
	"word": new WordFilter("filters.word"),
	"alignedWord": new AlignedWordFilter("filters.alignedWord"),
	"speaker": new ParticipantFilter("filters.speaker")
};

/*
 * Globals
 */
var session;

function begin_search(s) {
    session = s;
}

function setup_params(params) {
    var sep = new SeparatorScriptParam("PCC/PVC Options", false);
    params.add(sep);
    
    var pccStandardLbl = new LabelScriptParam("", "&lt;html&gt;&lt;b&gt;PCC/PVC (standard)&lt;/b&gt;&lt;/html&gt;");
    params.add(pccStandardLbl);
    pccOptions.standard.param_setup(params);

	var pccAlignedLbl = new LabelScriptParam("", "&lt;html&gt;&lt;b&gt;PCC/PVC (aligned)&lt;/b&gt;&lt;/html&gt;");
	params.add(pccAlignedLbl);
	pccOptions.aligned.param_setup(params);
	
	filters.group.param_setup(params);
	var sep = new LabelScriptParam("", "Aligned Group Filter");
	params.add(sep);
	filters.alignedGroup.param_setup(params);
	
	filters.word.searchByWordEnabled = false;
	filters.word.param_setup(params);
	var wordsep = new LabelScriptParam("", "&lt;html&gt;&lt;b&gt;Aligned Word&lt;/b&gt;&lt;/html&gt;");
	params.add(wordsep);
	filters.alignedWord.param_setup(params);

	filters.speaker.param_setup(params);
}

/********************************
 * query_record (required)
 *
 * Called for each record in a session.
 * Perform search operations here.
 *
 * params:
 *	record - current record
 * returns:
 *	void
 *******************************/
function query_record(recordIndex, record)
{
	if(!filters.speaker.check_speaker(record.speaker)) return;
    
	var searchObjects = filters.group.getRequestedGroups(record);
	// check aligned group for each group returned
	if(filters.alignedGroup.isUseFilter()) {
	    searchObjects = filters.alignedGroup.filter_groups(record, searchObjects);
	}
	
	for(var gIdx = 0; gIdx &lt; searchObjects.length; gIdx++) {
		var group = searchObjects[gIdx];
		var words = filters.word.getRequestedWords(group, "IPA Target");
		
		for(var wIdx = 0; wIdx &lt; words.length; wIdx++) {
			var word = words[wIdx];
			if(filters.alignedWord.isUseFilter()) {
				var alignedWord = word.getTier(filters.alignedWord.tierName);
				if(!filters.alignedWord.patternFilter.check_filter(alignedWord)) continue;
			}
			
			if(ignoreTruncated &amp;&amp; word.getIPAActual() == null || word.getIPAActual().length() == 0) {
				continue;
			}
			
		    var ipaT = (word.getIPATarget() != null ? word.getIPATarget() : new IPATranscript());
		    var ipaA = (word.getIPAActual() != null ? word.getIPAActual() : new IPATranscript());
		    
		    var result = factory.createResult();
		    result.schema = "ALIGNED";
		    result.recordIndex = recordIndex;
		    
		    var rvt = factory.createResultValue();
		    rvt.tierName = "IPA Target";
	    	rvt.groupIndex = gIdx;
	    	var startIndex = word.getIPATargetWordLocation();
	    	var endIndex = startIndex + ipaT.toString().length();
	    	rvt.range = new Range(startIndex, endIndex, false);
	    	rvt.data = ipaT;
	    	result.addResultValue(rvt);
	    	
	    	var rva = factory.createResultValue();
	    	rva.tierName = "IPA Actual";
	    	rva.groupIndex = gIdx;
	    	startIndex = word.getIPAActualWordLocation();
	    	endIndex = startIndex + ipaA.toString().length();
	    	rva.range = new Range(startIndex, endIndex, false);
	    	rva.data = ipaA;
	        result.addResultValue(rva);
		    
		    var metadata = result.metadata;
		    
		    // exclude values which bias results. 
		    // (e.g., all-vowel words such as 'eau' in French when looking only at PCC)
		    if( (pccOptions.standard.includePcc == true || pccOptions.aligned.includePcc == true)
		    		&amp;&amp; (pccOptions.standard.includePvc == false &amp;&amp; pccOptions.aligned.includePvc == false)
		    		&amp;&amp; ipaT.indexOf("\\c") &lt; 0) {
		    	continue;
		    }
		    if( (pccOptions.standard.includePcc == false &amp;&amp; pccOptions.aligned.includePcc == false)
		    		&amp;&amp; (pccOptions.standard.includePvc == true || pccOptions.aligned.includePvc == true)
		    		&amp;&amp; ipaT.indexOf("\\v") &lt; 0) {
		    	continue;
		    }
		    
		    pccOptions.standard.setup_pcc_standard_metadata(word, metadata);
		    pccOptions.aligned.setup_pcc_aligned_metadata(word, metadata);
		    
		    results.addResult(result);
		}
	}
}
</source>
                    <param id="pccOptions.aligned.includePvc">true</param>
                </script>
            </qry:query>
            <extensions>
                <oga:settings/>
                <oga:meta x="292" y="109"/>
            </extensions>
        </opqry:queryNode>
        <node id="75a06e67" type="class:ca.phon.app.opgraph.nodes.query.ResultsToTableNode">
            <extensions>
                <oga:settings>
                    <oga:property key="includeMetadata"><![CDATA[true]]></oga:property>
                    <oga:property key="includeTierInfo"><![CDATA[true]]></oga:property>
                    <oga:property key="includeSpeakerInfo"><![CDATA[true]]></oga:property>
                    <oga:property key="includeSessionInfo"><![CDATA[true]]></oga:property>
                    <oga:property key="includeExtraColumns"><![CDATA[true]]></oga:property>
                </oga:settings>
                <oga:meta x="376" y="323"/>
            </extensions>
        </node>
        <node id="66c6e0e5" type="class:ca.phon.app.opgraph.nodes.log.PrintBufferNode">
            <extensions>
                <oga:settings>
                    <oga:property key="showTable"><![CDATA[true]]></oga:property>
                </oga:settings>
                <oga:meta x="590" y="322">
                    <oga:default for="buffer" type="java.lang.String">aPVC</oga:default>
                </oga:meta>
            </extensions>
        </node>
        <link dest="6eccf1d5" destField="sessions" source="3d5a75bf" sourceField="obj"/>
        <link dest="6eccf1d5" destField="project" source="36b3d879" sourceField="obj"/>
        <link dest="75a06e67" destField="project" source="6eccf1d5" sourceField="project"/>
        <link dest="75a06e67" destField="results" source="6eccf1d5" sourceField="results"/>
        <link dest="66c6e0e5" destField="data" source="75a06e67" sourceField="table"/>
        <extensions>
            <opqry:nodewizard type="ca.phon.app.opgraph.assessment.AssessmentWizardExtension">
                <opqry:info title="Aligned Percent Vowels Correct (aPVC)">
                    <opqry:message/>
                </opqry:info>
            </opqry:nodewizard>
            <nes:settings type="ca.phon.app.opgraph.assessment.AssessmentOpGraphEditorModel"/>
        </extensions>
    </graph>
</opgraph>
