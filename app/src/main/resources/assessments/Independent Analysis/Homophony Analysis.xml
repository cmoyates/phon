<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<opgraph xmlns="http://gedge.ca/ns/opgraph" xmlns:nes="https://www.phon.ca/ns/node_editor" xmlns:oga="http://gedge.ca/ns/opgraph-app" xmlns:opqry="https://phon.ca/ns/opgraph_query" xmlns:qry="http://phon.ling.mun.ca/ns/query">
    <graph id="root">
        <node id="1f553055" name="Project" type="class:ca.gedge.opgraph.nodes.reflect.ObjectNode">
            <extensions>
                <oga:settings>
                    <oga:property key="ca.gedge.opgraph.nodes.reflect.ObjectNode.declaredClass"><![CDATA[ca.phon.project.Project]]></oga:property>
                    <oga:property key="contextKey"><![CDATA[_project]]></oga:property>
                </oga:settings>
                <oga:meta x="15" y="15"/>
            </extensions>
        </node>
        <node id="17618678" name="Selected Sessions" type="class:ca.gedge.opgraph.nodes.reflect.ObjectNode">
            <extensions>
                <oga:settings>
                    <oga:property key="ca.gedge.opgraph.nodes.reflect.ObjectNode.declaredClass"><![CDATA[java.util.ArrayList]]></oga:property>
                    <oga:property key="contextKey"><![CDATA[_selectedSessions]]></oga:property>
                </oga:settings>
                <oga:meta x="89" y="241"/>
            </extensions>
        </node>
        <opqry:queryNode id="6b669128" name="Query : Word List" type="ca.phon.app.opgraph.nodes.query.QueryNode">
            <qry:query xmlns="http://phon.ling.mun.ca/ns/query" date="2016-05-05T07:25:23.357-02:30" name="Word List" uuid="30303739-1657-435b-afb3-e326bb52ece1">
                <script>
                    <source>/*
 * Phon - An open source tool for research in phonology.
 * Copyright (C) 2005 - 2015, Gregory Hedlund &lt;ghedlund@mun.ca&gt; and Yvan Rose &lt;yrose@mun.ca&gt;
 * Dept of Linguistics, Memorial University &lt;https://phon.ca&gt;
 * 
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 * 
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 * 
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
/**
 * Create a listing of aligned words from the Orthography/IPA Target/IPA Actual
 * tiers.
 */

var GroupFilter = require("lib/GroupFilter").GroupFilter;
var AlignedGroupFilter = require("lib/TierFilter").TierFilter;
var ParticipantFilter = require("lib/ParticipantFilter").ParticipantFilter;
var WordFilter = require("lib/WordFilter").WordFilter;
var AlignedWordFilter = require("lib/TierFilter").TierFilter;

var filters = {
		"group": new GroupFilter("filters.group"),
		"alignedGroup": new AlignedGroupFilter("filters.alignedGroup"),
		"word": new WordFilter("filters.word"),
		"alignedWord": new AlignedWordFilter("filters.alignedWord"),
		"speaker": new ParticipantFilter("filters.speaker")
};

var session;

function begin_search(s) {
	session = s;
}

function setup_params(params) {
	filters.group.param_setup(params);
	var sep = new LabelScriptParam("", "Aligned Group Filter");
	params.add(sep);
	filters.alignedGroup.param_setup(params);
	
	filters.word.searchByWordEnabled = false;
	filters.word.param_setup(params);
	var wordsep = new LabelScriptParam("", "&lt;html&gt;&lt;b&gt;Aligned Word&lt;/b&gt;&lt;/html&gt;");
	params.add(wordsep);
	filters.alignedWord.param_setup(params);

	filters.speaker.param_setup(params);
}

function query_record(recordIndex, record) {
	if(!filters.speaker.check_speaker(record.speaker)) return;
    
	var searchObjects = filters.group.getRequestedGroups(record);
	// check aligned group for each group returned
	if(filters.alignedGroup.isUseFilter()) {
	    searchObjects = filters.alignedGroup.filter_groups(record, searchObjects);
	}
	
	for(var gIdx = 0; gIdx &lt; searchObjects.length; gIdx++) {
		var group = searchObjects[gIdx];
		
		// use 'IPA Target' as our source tier
		var words = filters.word.getRequestedWords(group, "IPA Target");
		
		for(var wIdx = 0; wIdx &lt; words.length; wIdx++) {
			var word = words[wIdx];
			var ortho = word.orthography || new Orthography();
			var ipaT = word.IPATarget || new IPATranscript();
			var ipaA = word.IPAActual || new IPATranscript();
			
			var result = factory.createResult();
			result.schema = "ALIGNED";
			result.recordIndex = recordIndex;
			
			var rv1 = factory.createResultValue();
			rv1.tierName = "Orthography";
	    	rv1.groupIndex = gIdx;
	    	var startIndex = (ortho.toString().length() &gt; 0 ? word.getOrthographyWordLocation() : 0);
	    	var endIndex = startIndex + ortho.toString().length();
	    	rv1.range = new Range(startIndex, endIndex, false);
	    	rv1.data = ortho;
	    	result.addResultValue(rv1);
	    	
	    	var rvt = factory.createResultValue();
		    rvt.tierName = "IPA Target";
	    	rvt.groupIndex = gIdx;
	    	var startIndex = (ipaT.length() &gt; 0 ? word.getIPATargetWordLocation() : 0);
	    	var endIndex = startIndex + ipaT.toString().length();
	    	rvt.range = new Range(startIndex, endIndex, false);
	    	rvt.data = ipaT;
	    	result.addResultValue(rvt);
	    	
	    	var rva = factory.createResultValue();
	    	rva.tierName = "IPA Actual";
	    	rva.groupIndex = gIdx;
	    	startIndex = (ipaA.length() &gt; 0 ? word.getIPAActualWordLocation() : 0);
	    	endIndex = startIndex + ipaA.toString().length();
	    	rva.range = new Range(startIndex, endIndex, false);
	    	rva.data = ipaA;
	        result.addResultValue(rva);
	        
	        results.addResult(result);
		}
	}
}
</source>
                </script>
            </qry:query>
            <extensions>
                <oga:settings/>
                <oga:meta x="285" y="106"/>
            </extensions>
        </opqry:queryNode>
        <node id="4f355b5e" type="class:ca.phon.app.opgraph.nodes.query.ResultsToTableNode">
            <extensions>
                <oga:settings>
                    <oga:property key="includeMetadata"><![CDATA[true]]></oga:property>
                    <oga:property key="includeTierInfo"><![CDATA[true]]></oga:property>
                    <oga:property key="includeSpeakerInfo"><![CDATA[true]]></oga:property>
                    <oga:property key="includeSessionInfo"><![CDATA[true]]></oga:property>
                    <oga:property key="includeExtraColumns"><![CDATA[true]]></oga:property>
                </oga:settings>
                <oga:meta x="496" y="117"/>
            </extensions>
        </node>
        <node id="83eabaf" type="class:ca.phon.app.opgraph.nodes.query.HomophonyAnalysis">
            <extensions>
                <oga:settings>
                    <oga:property key="ignoreDiacritics"><![CDATA[true]]></oga:property>
                </oga:settings>
                <oga:meta x="297" y="264"/>
            </extensions>
        </node>
        <node id="4033c1d4" type="class:ca.phon.app.opgraph.nodes.log.PrintBufferNode">
            <extensions>
                <oga:settings>
                    <oga:property key="showTable"><![CDATA[true]]></oga:property>
                </oga:settings>
                <oga:meta x="519" y="266">
                    <oga:default for="buffer" type="java.lang.String">Homophony Analysis</oga:default>
                </oga:meta>
            </extensions>
        </node>
        <link dest="6b669128" destField="project" source="1f553055" sourceField="obj"/>
        <link dest="6b669128" destField="sessions" source="17618678" sourceField="obj"/>
        <link dest="4f355b5e" destField="project" source="6b669128" sourceField="project"/>
        <link dest="4f355b5e" destField="results" source="6b669128" sourceField="results"/>
        <link dest="83eabaf" destField="table" source="4f355b5e" sourceField="table"/>
        <link dest="4033c1d4" destField="data" source="83eabaf" sourceField="table"/>
        <extensions>
            <opqry:nodewizard type="ca.phon.app.opgraph.assessment.AssessmentWizardExtension">
                <opqry:info title="Introduction">
                    <opqry:message/>
                </opqry:info>
            </opqry:nodewizard>
            <nes:settings type="ca.phon.app.opgraph.assessment.AssessmentOpGraphEditorModel"/>
        </extensions>
    </graph>
</opgraph>
